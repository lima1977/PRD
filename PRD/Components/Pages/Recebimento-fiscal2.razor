@page "/recebimento-fiscal2"
@using MudBlazor
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-2">
    <!-- Compact Header -->
    <MudPaper Elevation="0" Class="mb-3 pa-4" Style="background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 50%, #7c3aed 100%); border-radius: 16px;">
        <MudGrid>
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudAvatar Color="Color.Surface" Size="Size.Large" Class="mr-3">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h5" Color="Color.Surface" Class="font-weight-bold">Recebimento Fiscal</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Surface" Style="opacity: 0.9;">Usuário: JD</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end">
                <MudChip T ="string" Color="Color.Surface" Icon="@Icons.Material.Filled.Inventory" Size="Size.Large">
                    <b>@totalLancamentos</b> Lançamentos
                </MudChip>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid>
        <!-- Left Panel - Formulário -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 16px; height: 100%;">
                <!-- Tabs para organizar informações -->
                <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" Position="Position.Top" PanelClass="pa-4">
                    
                    <!-- Tab 1: Dados do Transporte -->
                    <MudTabPanel Text="Transporte" Icon="@Icons.Material.Filled.LocalShipping">
                        <MudGrid Spacing="2">
                            <MudItem xs="6" sm="4">
                                <MudTextField Label="Nº Controle" @bind-Value="numeroControle" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="4">
                                <MudDatePicker Label="Data" @bind-Date="dataChegada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudTimePicker Label="Hora" @bind-Time="horaChegada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Transportadora" @bind-Value="transportadora" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Business" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Motorista" @bind-Value="nomeMotorista" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Telefone" @bind-Value="telefone" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Mask="@(new PatternMask("(00) 00000-0000"))" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="RG" @bind-Value="rg" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="CPF" @bind-Value="cpf" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Mask="@(new PatternMask("000.000.000-00"))" />
                            </MudItem>
                            
                            <MudItem xs="6">
                                <MudTextField Label="Placa Carreta" @bind-Value="placaCarreta" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Mask="@(new PatternMask("XXX-0X00"))" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudTextField Label="Placa Cavalo" @bind-Value="placaCavalo" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Mask="@(new PatternMask("XXX-0X00"))" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField Label="E-mail" @bind-Value="email" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" InputType="InputType.Email" />
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <!-- Tab 2: Dados Fiscais -->
                    <MudTabPanel Text="Fiscal" Icon="@Icons.Material.Filled.Assignment">
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Fornecedor" @bind-Value="fornecedor" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Store" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Nota Fiscal" @bind-Value="notaFiscal" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Qtde NF" @bind-Value="qtdeNF" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudSelect T="string" Label="Tipo Depósito" @bind-Value="tipoDeposito" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense">
                                    <MudSelectItem Value="@("Produto Acabado")">Produto Acabado</MudSelectItem>
                                    <MudSelectItem Value="@("Matéria Prima")">Matéria Prima</MudSelectItem>
                                    <MudSelectItem Value="@("Embalagem")">Embalagem</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudSelect T="string" Label="Categorias" @bind-Value="categorias" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense">
                                    <MudSelectItem Value="@("Alimentos")">Alimentos</MudSelectItem>
                                    <MudSelectItem Value="@("Bebidas")">Bebidas</MudSelectItem>
                                    <MudSelectItem Value="@("Eletrônicos")">Eletrônicos</MudSelectItem>
                                    <MudSelectItem Value="@("Têxtil")">Têxtil</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="6" sm="4">
                                <MudSelect T="string" Label="Divergências" @bind-Value="divergencias" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense">
                                    <MudSelectItem Value="@("Sem Divergências")">Sem Divergências</MudSelectItem>
                                    <MudSelectItem Value="@("Avaria")">Avaria</MudSelectItem>
                                    <MudSelectItem Value="@("Quantidade")">Quantidade</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="6" sm="4">
                                <MudSelect T="string" Label="Status" @bind-Value="statusFiscal" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense">
                                    <MudSelectItem Value="@("Aguardando")">Aguardando</MudSelectItem>
                                    <MudSelectItem Value="@("Em Conferência")">Em Conferência</MudSelectItem>
                                    <MudSelectItem Value="@("Finalizado")">Finalizado</MudSelectItem>
                                    <MudSelectItem Value="@("Pendente")">Pendente</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudTextField Label="Senha" @bind-Value="senha" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" InputType="InputType.Password" />
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Qtde Pçs" @bind-Value="qtdePcs" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data Lanç." @bind-Date="dataLancamento" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Envio" @bind-Time="horaEnvio" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Retorno" @bind-Time="horaRetorno" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="6">
                                <MudDatePicker Label="Data Chamada" @bind-Date="dataChamada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudTimePicker Label="Hora Chamada" @bind-Time="horaHoraChamada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField Label="Observações" @bind-Value="observacoes" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Lines="3" />
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>

                <!-- Action Buttons -->
                <MudDivider Class="my-3" />
                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="SalvarDados">Salvar</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit">Alterar</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Clear" OnClick="LimparFormulario">Limpar</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Right Panel - Status e Consulta Rápida -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="2">
                <!-- Quick Stats -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Small" /> Status Rápido
                    </MudText>
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">8</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Finalizados</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">3</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Em Conf.</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">2</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Aguardando</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">1</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Pendentes</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <!-- Busca Rápida -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" /> Busca Rápida
                    </MudText>
                    <MudStack Spacing="2">
                        <MudDatePicker Label="Data" @bind-Date="dataConsulta" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        <MudTextField Label="Buscar..." @bind-Value="busca" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" 
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search">
                            Buscar
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Últimos Registros -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" /> Últimos Registros
                    </MudText>
                    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start" Dense="true">
                        @foreach (var item in lancamentosFiscais.Take(3))
                        {
                            <MudTimelineItem Size="Size.Small" Color="@GetStatusColor(item.Status)">
                                <ItemContent>
                                    <MudText Typo="Typo.body2" Class="font-weight-medium">@item.Motorista</MudText>
                                    <MudText Typo="Typo.caption">NF: @item.NotaFiscal • @item.Hora</MudText>
                                </ItemContent>
                            </MudTimelineItem>
                        }
                    </MudTimeline>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    <!-- Tabela de Lançamentos - Full Width -->
    <MudPaper Elevation="2" Class="mt-3 pa-4" Style="border-radius: 16px;">
        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.TableChart" /> Lançamentos Fiscais
        </MudText>
        <MudTable Items="@lancamentosFiscais" Hover="true" Dense="true" Striped="true" Elevation="0">
            <HeaderContent>
                <MudTh>Data/Hora</MudTh>
                <MudTh>Motorista</MudTh>
                <MudTh>Transportadora</MudTh>
                <MudTh>NF</MudTh>
                <MudTh>Fornecedor</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: center;">Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Data/Hora">
                    <MudText Typo="Typo.body2">@context.Data</MudText>
                    <MudText Typo="Typo.caption">@context.Hora</MudText>
                </MudTd>
                <MudTd DataLabel="Motorista">@context.Motorista</MudTd>
                <MudTd DataLabel="Transportadora">@context.Transportadora</MudTd>
                <MudTd DataLabel="NF">@context.NotaFiscal</MudTd>
                <MudTd DataLabel="Fornecedor">@context.Fornecedor</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small" Variant="Variant.Filled">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Ações" Style="text-align: center;">
                    <MudTooltip Text="Editar">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditarRegistro(context))" />
                    </MudTooltip>
                    <MudTooltip Text="Imprimir">
                        <MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" OnClick="@(() => ImprimirRegistro(context))" />
                    </MudTooltip>
                    <MudTooltip Text="Excluir">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => ExcluirRegistro(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private string numeroControle = "";
    private DateTime? dataChegada = DateTime.Now;
    private TimeSpan? horaChegada = DateTime.Now.TimeOfDay;
    private string transportadora = "";
    private string nomeMotorista = "";
    private string telefone = "";
    private string placaCarreta = "";
    private string placaCavalo = "";
    private string rg = "";
    private string cpf = "";
    private string email = "";
    private string fornecedor = "";
    private string notaFiscal = "";
    private string tipoDeposito = "";
    private string divergencias = "Sem Divergências";
    private string statusFiscal = "Aguardando";
    private string senha = "";
    private string qtdeNF = "";
    private DateTime? dataLancamento = DateTime.Now;
    private TimeSpan? horaEnvio = DateTime.Now.TimeOfDay;
    private string qtdePcs = "";
    private string categorias = "";
    private DateTime? dataChamada = DateTime.Now;
    private TimeSpan? horaRetorno;
    private TimeSpan? horaHoraChamada;
    private string observacoes = "";
    private DateTime? dataConsulta = DateTime.Now;
    private string busca = "";
    private int totalLancamentos = 14;

    private List<LancamentoFiscal> lancamentosFiscais = new()
    {
        new LancamentoFiscal { Data = "10/11/2025", Hora = "08:00", Motorista = "José Santos", Transportadora = "Rápida Express", NotaFiscal = "12345", Fornecedor = "Fornecedor A", Status = "Finalizado" },
        new LancamentoFiscal { Data = "10/11/2025", Hora = "09:30", Motorista = "Maria Silva", Transportadora = "Trans Brasil", NotaFiscal = "12346", Fornecedor = "Fornecedor B", Status = "Em Conferência" },
        new LancamentoFiscal { Data = "10/11/2025", Hora = "10:15", Motorista = "Carlos Oliveira", Transportadora = "Log Master", NotaFiscal = "12347", Fornecedor = "Fornecedor C", Status = "Aguardando" },
        new LancamentoFiscal { Data = "10/11/2025", Hora = "11:00", Motorista = "Ana Costa", Transportadora = "Express Cargo", NotaFiscal = "12348", Fornecedor = "Fornecedor D", Status = "Pendente" }
    };

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Finalizado" => Color.Success,
            "Em Conferência" => Color.Info,
            "Aguardando" => Color.Warning,
            "Pendente" => Color.Error,
            _ => Color.Default
        };
    }

    private void SalvarDados() { }

    private void LimparFormulario()
    {
        numeroControle = ""; nomeMotorista = ""; telefone = ""; placaCarreta = ""; placaCavalo = "";
        rg = ""; cpf = ""; email = ""; transportadora = ""; fornecedor = ""; notaFiscal = "";
        tipoDeposito = ""; divergencias = "Sem Divergências"; statusFiscal = "Aguardando";
        senha = ""; qtdeNF = ""; qtdePcs = ""; categorias = ""; observacoes = "";
    }

    private void EditarRegistro(LancamentoFiscal registro)
    {
        nomeMotorista = registro.Motorista;
        transportadora = registro.Transportadora;
        notaFiscal = registro.NotaFiscal;
        fornecedor = registro.Fornecedor;
        statusFiscal = registro.Status;
    }

    private async Task ImprimirRegistro(LancamentoFiscal registro)
    {
        var dataHoraAtual = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
        var statusClass = registro.Status.ToLower().Replace(" ", "-");
        
        var html = @"
<html>
<head>
    <title>Comprovante Recebimento Fiscal</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #667eea; }
        .info-row { display: flex; margin-bottom: 10px; }
        .info-label { font-weight: bold; width: 150px; }
        .info-value { flex: 1; }
        .section { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; }
        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: white; }
        .status-finalizado { background-color: #4caf50; }
        .status-em-conferência { background-color: #2196f3; }
        .status-pendente { background-color: #f44336; }
        .status-aguardando { background-color: #ff9800; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class='header'>
        <h1>COMPROVANTE DE RECEBIMENTO FISCAL</h1>
    </div>
    <div class='section'>
        <h3>Informações</h3>
        <div class='info-row'><span class='info-label'>Data:</span><span class='info-value'>" + registro.Data + @"</span></div>
        <div class='info-row'><span class='info-label'>Hora:</span><span class='info-value'>" + registro.Hora + @"</span></div>
        <div class='info-row'><span class='info-label'>NF:</span><span class='info-value'>" + registro.NotaFiscal + @"</span></div>
        <div class='info-row'><span class='info-label'>Status:</span><span class='info-value'><span class='status status-" + statusClass + "'>" + registro.Status + @"</span></span></div>
    </div>
    <div class='section'>
        <h3>Transporte</h3>
        <div class='info-row'><span class='info-label'>Motorista:</span><span class='info-value'>" + registro.Motorista + @"</span></div>
        <div class='info-row'><span class='info-label'>Transportadora:</span><span class='info-value'>" + registro.Transportadora + @"</span></div>
        <div class='info-row'><span class='info-label'>Fornecedor:</span><span class='info-value'>" + registro.Fornecedor + @"</span></div>
    </div>
    <div class='footer'><p>Gerado em " + dataHoraAtual + @" - Usuário: JD</p></div>
    <script>window.onload = function() { window.print(); }</script>
</body>
</html>";

        var htmlEscaped = html.Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "");
        await JSRuntime.InvokeVoidAsync("eval", "var w = window.open('', '_blank'); w.document.write('" + htmlEscaped + "'); w.document.close();");
    }

    private void ExcluirRegistro(LancamentoFiscal registro)
    {
        lancamentosFiscais.Remove(registro);
        totalLancamentos = lancamentosFiscais.Count;
    }

    public class LancamentoFiscal
    {
        public string Data { get; set; }
        public string Hora { get; set; }
        public string Motorista { get; set; }
        public string Transportadora { get; set; }
        public string NotaFiscal { get; set; }
        public string Fornecedor { get; set; }
        public string Status { get; set; }
    }
}