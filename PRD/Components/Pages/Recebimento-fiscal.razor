@page "/recebimento-fiscal"
@using MudBlazor
@using PRD.Intefaces
@using PRD.Model
@inject IJSRuntime JSRuntime
@inject IBaseLNcsService BaseLNcsService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-2">
    <!-- Compact Header -->
    <MudPaper Elevation="0" Class="mb-3 pa-4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
        <MudGrid>
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudAvatar Color="Color.Surface" Size="Size.Large" Class="mr-3">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h5" Color="Color.Surface" Class="font-weight-bold">Recebimento Fiscal</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Surface" Style="opacity: 0.9;">Usuário: JD</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end">
                <MudChip T = "string" Color="Color.Surface" Icon="@Icons.Material.Filled.Inventory" Size="Size.Large">
                    <b>@totalLancamentos</b> Lançamentos
                </MudChip>
            </MudItem>
        </MudGrid>

    </MudPaper>
       <MudPaper Elevation="0" Height="60px" Class="mb-3 pa-3" Style=" border-radius: 16px">
        <MudGrid>
            <MudItem xs="12" md="12" Class="d-flex align-center justify-content-center m-2">

             <MudIcon Icon="@Icons.Material.Filled.Favorite" Title="Favorite" />
            <MudIcon Icon="@Icons.Material.Filled.Api" Title="API" />
            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Title="Add" />
            <MudIcon Icon="@Icons.Custom.Brands.GitHub" Title="GitHub" />
            <MudIcon Icon="@Icons.Custom.Brands.Google" Title="Google" />
            <MudIcon Icon="@Icons.Custom.Brands.Reddit" Title="Reddit" />
                        </MudItem>

        </MudGrid>
    </MudPaper>
    <MudGrid>
        <!-- Left Panel - Formulário -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 16px; height: 100%;">
                <!-- Tabs para organizar informações -->
                <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" Position="Position.Top" PanelClass="pa-4">
                    
                    <!-- Tab 1: Dados do Transporte -->
                    <MudTabPanel Text="Transporte" Icon="@Icons.Material.Filled.LocalShipping">
                        <MudGrid Spacing="2">
                            <!-- Autocomplete para Número de Controle -->
                            <MudItem xs="12" sm="6">
                                <MudAutocomplete 
                                    T="BaseLNcs" 
                                    Label="Número Controle (ID)" 
                                    @bind-Value="registroSelecionado"
                                    SearchFunc="@BuscarPorNumeroControle"
                                    ToStringFunc="@(e => e?.Id.ToString())"
                                    Variant="Variant.Filled" 
                                    Dense="true" 
                                    Margin="Margin.Dense"
                                    Adornment="Adornment.Start" 
                                    AdornmentIcon="@Icons.Material.Filled.Tag"
                                    ResetValueOnEmptyText="true"
                                    CoerceText="true"
                                    CoerceValue="true"
                                    DebounceInterval="300"
                                    OnBlur="@CarregarDadosRegistro">
                                    <ItemTemplate Context="item">
                                        <MudText Typo="Typo.body2">ID: @item.Id - @item.Fornecedor</MudText>
                                        <MudText Typo="Typo.caption">NF: @item.NotaFiscal • @item.DataChegada?.ToString("dd/MM/yyyy")</MudText>
                                    </ItemTemplate>
                                </MudAutocomplete>
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data" @bind-Date="dataChegada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora" @bind-Time="horaChegada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Transportadora" @bind-Value="transportadora" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Business" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Código Transportadora" @bind-Value="codigoTransportadora" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Nome Transportadora" @bind-Value="nomeTransportadora" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="CNPJ Transportadora" @bind-Value="cnpjTransportadora" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Placa Veículo" @bind-Value="placaVeiculo" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Mask="@(new PatternMask("XXX-0X00"))" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Doca" @bind-Value="doca" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <!-- Tab 2: Dados Fiscais -->
                    <MudTabPanel Text="Fiscal" Icon="@Icons.Material.Filled.Assignment">
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Fornecedor" @bind-Value="fornecedor" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Store" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Razão Social" @bind-Value="razaoSocial" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Nota Fiscal" @bind-Value="notaFiscal" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Série" @bind-Value="serie" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Qtd Agendada" @bind-Value="qtdAgendada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTextField Label="Qtd Recebida" @bind-Value="qtdRecebida" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Tipo Depósito" @bind-Value="tipoDeposito" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Categoria Plano" @bind-Value="categoriaPlano" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Armazém" @bind-Value="armazem" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Senha" @bind-Value="senha" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudSelect T="string" Label="Status" @bind-Value="statusFiscal" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense">
                                    <MudSelectItem Value="@("Aguardando")">Aguardando</MudSelectItem>
                                    <MudSelectItem Value="@("Em Conferência")">Em Conferência</MudSelectItem>
                                    <MudSelectItem Value="@("Finalizado")">Finalizado</MudSelectItem>
                                    <MudSelectItem Value="@("Pendente")">Pendente</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Status Senha" @bind-Value="statusSenha" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data Lanç." @bind-Date="dataLancamento" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Lanç." @bind-Time="horaLancamento" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data Envio" @bind-Date="dataEnvioBOSS" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Envio" @bind-Time="horaEnvioBOSS" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data Chamada" @bind-Date="dataChamada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Chamada" @bind-Time="horaChamada" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudDatePicker Label="Data Aprova." @bind-Date="dataAprovacao" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudTimePicker Label="Hora Aprova." @bind-Time="horaAprovacao" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Pedido" @bind-Value="pedido" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Localizador" @bind-Value="localizador" Variant="Variant.Filled" Dense="true" Margin="Margin.Dense" ReadOnly="true" />
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>

                <!-- Action Buttons -->
                <MudDivider Class="my-3" />
                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="SalvarDados">Salvar</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit">Alterar</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Clear" OnClick="LimparFormulario">Limpar</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Right Panel - Status e Consulta Rápida -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="2">
                <!-- Quick Stats -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Small" /> Status Rápido
                    </MudText>
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">@finalizados</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Finalizados</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">@emConferencia</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Em Conf.</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">@aguardando</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Aguardando</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">@pendentes</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Pendentes</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <!-- Busca Rápida -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" /> Busca Rápida
                    </MudText>
                    <MudStack Spacing="2">
                        <MudDatePicker Label="Data" @bind-Date="dataConsulta" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        <MudTextField Label="Buscar..." @bind-Value="busca" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" 
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" OnClick="BuscarRegistros">
                            Buscar
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    <!-- Tabela de Lançamentos -->
    <MudPaper Elevation="2" Class="mt-3 pa-4" Style="border-radius: 16px;">
        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.TableChart" /> Lançamentos Fiscais
        </MudText>
        <MudTable Items="@registrosFiltrados" Hover="true" Dense="true" Striped="true" Elevation="0" Loading="@carregando" PageSize="@pageSize">

            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Data/Hora</MudTh>
                <MudTh>Fornecedor</MudTh>
                <MudTh>Transportadora</MudTh>
                <MudTh>NF</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: center;">Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.Id</MudTd>
                <MudTd DataLabel="Data/Hora">
                    <MudText Typo="Typo.body2">@context.DataChegada?.ToString("dd/MM/yyyy")</MudText>
                    <MudText Typo="Typo.caption">@context.HoraChegada?.ToString(@"hh\:mm")</MudText>
                </MudTd>
                <MudTd DataLabel="Fornecedor">@context.Fornecedor</MudTd>
                <MudTd DataLabel="Transportadora">@context.Transportadora</MudTd>
                <MudTd DataLabel="NF">@context.NotaFiscal</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small" Variant="Variant.Filled">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Ações" Style="text-align: center;">
                    <MudTooltip Text="Editar">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditarRegistro(context))" />
                    </MudTooltip>
                    <MudTooltip Text="Imprimir">
                        <MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" OnClick="@(() => ImprimirRegistro(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>

                  <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }"
                                       InfoFormat="{first_item}-{last_item} de {all_items}"
                                       RowsPerPageString="Linhas por página:" />
                    </PagerContent>

        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    // Lista completa de registros
    private List<BaseLNcs> todosRegistros = new();
    private List<BaseLNcs> registrosFiltrados = new();
    private BaseLNcs? registroSelecionado;
    private bool carregando = false;
     private int pageSize = 50000; // Definido corretamente como 10
    // Campos do formulário
    private DateTime? dataChegada;
    private TimeSpan? horaChegada;
    private string transportadora = "";
    private string codigoTransportadora = "";
    private string nomeTransportadora = "";
    private string cnpjTransportadora = "";
    private string placaVeiculo = "";
    private string doca = "";
    private string fornecedor = "";
    private string razaoSocial = "";
    private string notaFiscal = "";
    private string serie = "";
    private decimal? qtdAgendada;
    private decimal? qtdRecebida;
    private string tipoDeposito = "";
    private string categoriaPlano = "";
    private string armazem = "";
    private string senha = "";
    private string statusFiscal = "Aguardando";
    private string statusSenha = "";
    private DateTime? dataLancamento;
    private TimeSpan? horaLancamento;
    private DateTime? dataEnvioBOSS;
    private TimeSpan? horaEnvioBOSS;
    private DateTime? dataChamada;
    private TimeSpan? horaChamada;
    private DateTime? dataAprovacao;
    private TimeSpan? horaAprovacao;
    private string pedido = "";
    private string localizador = "";

    // Consulta
    private DateTime? dataConsulta = DateTime.Now;
    private string busca = "";
    
    // Estatísticas
    private int totalLancamentos = 0;
    private int finalizados = 0;
    private int emConferencia = 0;
    private int aguardando = 0;
    private int pendentes = 0;

    protected override async Task OnInitializedAsync()
    {
       //await CarregarDados();


         try
        {
            carregando = true;
            todosRegistros = await BaseLNcsService.ObterTodosAsync(); // Carrega todos os registros
            totalLancamentos = todosRegistros.Count;
            AtualizarEstatisticas();
            CarregarPagina(0); // Carrega a primeira página
            carregando = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados: {ex.Message}", Severity.Error);
            carregando = false;
        }

    }
      // Função para carregar os dados de uma página específica
    private void CarregarPagina(int pagina)
    {
        registrosFiltrados = todosRegistros.Skip(pagina * pageSize).Take(pageSize).ToList();
    }


    // private async Task CarregarDados()
    // {
    //     try
    //     {
    //         carregando = true;
    //         todosRegistros = await BaseLNcsService.ObterTodosAsync();
    //         registrosFiltrados = todosRegistros;
    //         totalLancamentos = todosRegistros.Count;
    //         AtualizarEstatisticas();
    //         carregando = false;
    //     }
    //     catch (Exception ex)
    //     {
    //         Snackbar.Add($"Erro ao carregar dados: {ex.Message}", Severity.Error);
    //         carregando = false;
    //     }
    // }

    @code {
    private async Task CarregarDados()
    {
        try
        {
            carregando = true;
            int pagina = 0;  // Página inicial
            int tamanhoPagina = 100000; // Tamanho da página
            todosRegistros = await BaseLNcsService.ObterTodosAsync(pagina, tamanhoPagina); // Passando os parâmetros
            registrosFiltrados = todosRegistros;
            totalLancamentos = todosRegistros.Count;
            AtualizarEstatisticas();
            carregando = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados: {ex.Message}", Severity.Error);
            carregando = false;
        }
    }
}


    private void AtualizarEstatisticas()
    {
        finalizados = todosRegistros.Count(x => x.Status == "Finalizado");
        emConferencia = todosRegistros.Count(x => x.Status == "Em Conferência");
        aguardando = todosRegistros.Count(x => x.Status == "Aguardando");
        pendentes = todosRegistros.Count(x => x.Status == "Pendente");
    }


    private async Task<IEnumerable<BaseLNcs>> BuscarPorNumeroControle(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return todosRegistros.Take(1);

        return todosRegistros
            .Where(x => x.Id.ToString().Contains(value) ||
                        (x.Senha?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false) ||
                        (x.NotaFiscal?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(1);
    }

    private void CarregarDadosRegistro()
    {
        if (registroSelecionado == null) return;

        // Carregar todos os campos do registro selecionado
        dataChegada = registroSelecionado.DataChegada;
        horaChegada = registroSelecionado.HoraChegada;
        transportadora = registroSelecionado.Transportadora ?? "";
        codigoTransportadora = registroSelecionado.CodigoTransportadora ?? "";
        nomeTransportadora = registroSelecionado.NomeTransportadora ?? "";
        cnpjTransportadora = registroSelecionado.CnpjTransportadora ?? "";
        placaVeiculo = registroSelecionado.PlacaVeiculo ?? "";
        doca = registroSelecionado.Doca ?? "";
        fornecedor = registroSelecionado.Fornecedor ?? "";
        razaoSocial = registroSelecionado.RazaoSocial ?? "";
        notaFiscal = registroSelecionado.NotaFiscal ?? "";
        serie = registroSelecionado.Serie ?? "";
        qtdAgendada = registroSelecionado.QtdAgendada;
        qtdRecebida = registroSelecionado.QtdRecebida;
        tipoDeposito = registroSelecionado.TipoDeposito ?? "";
        categoriaPlano = registroSelecionado.CategoriaPlano ?? "";
        armazem = registroSelecionado.Armazem ?? "";
        senha = registroSelecionado.Senha ?? "";
        statusFiscal = registroSelecionado.Status ?? "Aguardando";
        statusSenha = registroSelecionado.StatusSenha ?? "";
        dataLancamento = registroSelecionado.DataLancamento;
        horaLancamento = registroSelecionado.HoraLancamento;
        dataEnvioBOSS = registroSelecionado.DataEnvioBOSS;
        horaEnvioBOSS = registroSelecionado.HoraEnvioBOSS;
        dataChamada = registroSelecionado.DataChamada;
        horaChamada = registroSelecionado.HoraChamada;
        dataAprovacao = registroSelecionado.DataAprovacao;
        horaAprovacao = registroSelecionado.HoraAprovacao;
        pedido = registroSelecionado.Pedido ?? "";
        localizador = registroSelecionado.Localizador ?? "";

        Snackbar.Add($"Registro ID {registroSelecionado.Id} carregado com sucesso!", Severity.Success);
    }

    private void BuscarRegistros()
    {
        if (string.IsNullOrWhiteSpace(busca))
        {
            registrosFiltrados = todosRegistros;
        }
        else
        {
            registrosFiltrados = todosRegistros
                .Where(x => x.Id.ToString().Contains(busca) ||
                           (x.Senha?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (x.NotaFiscal?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (x.Fornecedor?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }
        
        Snackbar.Add($"Encontrados {registrosFiltrados.Count} registros", Severity.Info);
    }

    private Color GetStatusColor(string? status)
    {
        return status switch
        {
            "Finalizado" => Color.Success,
            "Em Conferência" => Color.Info,
            "Aguardando" => Color.Warning,
            "Pendente" => Color.Error,
            _ => Color.Default
        };
    }

    private async Task SalvarDados()
    {
        if (registroSelecionado == null)
        {
            Snackbar.Add("Selecione um registro para salvar!", Severity.Warning);
            return;
        }

        try
        {
            // Atualizar o registro selecionado com os novos valores
            registroSelecionado.QtdRecebida = qtdRecebida;
            registroSelecionado.Status = statusFiscal;
            registroSelecionado.Senha = senha;
            registroSelecionado.StatusSenha = statusSenha;
            registroSelecionado.DataLancamento = dataLancamento;
            registroSelecionado.HoraLancamento = horaLancamento;
            registroSelecionado.DataEnvioBOSS = dataEnvioBOSS;
            registroSelecionado.HoraEnvioBOSS = horaEnvioBOSS;
            registroSelecionado.DataChamada = dataChamada;
            registroSelecionado.HoraChamada = horaChamada;
            registroSelecionado.DataAprovacao = dataAprovacao;
            registroSelecionado.HoraAprovacao = horaAprovacao;
            registroSelecionado.PlacaVeiculo = placaVeiculo;

            // Chamar o método de atualização do service
            var sucesso = await BaseLNcsService.AtualizarAsync(registroSelecionado);
            
            if (sucesso)
            {
                Snackbar.Add("Dados salvos com sucesso!", Severity.Success);
                await CarregarDados(); // Recarregar a lista
                AtualizarEstatisticas();
            }
            else
            {
                Snackbar.Add("Erro ao salvar dados!", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar: {ex.Message}", Severity.Error);
        }
    }

    private void LimparFormulario()
    {
        registroSelecionado = null;
        dataChegada = null;
        horaChegada = null;
        transportadora = "";
        codigoTransportadora = "";
        nomeTransportadora = "";
        cnpjTransportadora = "";
        placaVeiculo = "";
        doca = "";
        fornecedor = "";
        razaoSocial = "";
        notaFiscal = "";
        serie = "";
        qtdAgendada = null;
        qtdRecebida = null;
        tipoDeposito = "";
        categoriaPlano = "";
        armazem = "";
        senha = "";
        statusFiscal = "Aguardando";
        statusSenha = "";
        dataLancamento = null;
        horaLancamento = null;
        dataEnvioBOSS = null;
        horaEnvioBOSS = null;
        dataChamada = null;
        horaChamada = null;
        dataAprovacao = null;
        horaAprovacao = null;
        pedido = "";
        localizador = "";
        
        Snackbar.Add("Formulário limpo!", Severity.Info);
    }

    private void EditarRegistro(BaseLNcs registro)
    {
        registroSelecionado = registro;
        CarregarDadosRegistro();
    }

    private async Task ImprimirRegistro(BaseLNcs registro)
    {
        var dataHoraAtual = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
        var statusClass = registro.Status?.ToLower().Replace(" ", "-") ?? "aguardando";
        
        var html = @"
<html>
<head>
    <title>Comprovante Recebimento Fiscal</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #667eea; }
        .info-row { display: flex; margin-bottom: 10px; }
        .info-label { font-weight: bold; width: 150px; }
        .info-value { flex: 1; }
        .section { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; }
        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: white; }
        .status-finalizado { background-color: #4caf50; }
        .status-em-conferência { background-color: #2196f3; }
        .status-pendente { background-color: #f44336; }
        .status-aguardando { background-color: #ff9800; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class='header'>
        <h1>COMPROVANTE DE RECEBIMENTO FISCAL</h1>
        <p>Controle ID: " + registro.Id + @"</p>
    </div>
    <div class='section'>
        <h3>Informações de Recebimento</h3>
        <div class='info-row'><span class='info-label'>Data:</span><span class='info-value'>" + registro.DataChegada?.ToString("dd/MM/yyyy") + @"</span></div>
        <div class='info-row'><span class='info-label'>Hora:</span><span class='info-value'>" + registro.HoraChegada?.ToString(@"hh\:mm") + @"</span></div>
        <div class='info-row'><span class='info-label'>NF:</span><span class='info-value'>" + registro.NotaFiscal + @" - Série: " + registro.Serie + @"</span></div>
        <div class='info-row'><span class='info-label'>Status:</span><span class='info-value'><span class='status status-" + statusClass + "'>" + registro.Status + @"</span></span></div>
    </div>
    <div class='section'>
        <h3>Dados Fiscais</h3>
        <div class='info-row'><span class='info-label'>Fornecedor:</span><span class='info-value'>" + registro.Fornecedor + @"</span></div>
        <div class='info-row'><span class='info-label'>Razão Social:</span><span class='info-value'>" + registro.RazaoSocial + @"</span></div>
        <div class='info-row'><span class='info-label'>Qtd Agendada:</span><span class='info-value'>" + registro.QtdAgendada + @"</span></div>
        <div class='info-row'><span class='info-label'>Qtd Recebida:</span><span class='info-value'>" + registro.QtdRecebida + @"</span></div>
    </div>
    <div class='section'>
        <h3>Dados do Transporte</h3>
        <div class='info-row'><span class='info-label'>Transportadora:</span><span class='info-value'>" + registro.Transportadora + @"</span></div>
        <div class='info-row'><span class='info-label'>Nome:</span><span class='info-value'>" + registro.NomeTransportadora + @"</span></div>
        <div class='info-row'><span class='info-label'>CNPJ:</span><span class='info-value'>" + registro.CnpjTransportadora + @"</span></div>
        <div class='info-row'><span class='info-label'>Placa:</span><span class='info-value'>" + registro.PlacaVeiculo + @"</span></div>
        <div class='info-row'><span class='info-label'>Doca:</span><span class='info-value'>" + registro.Doca + @"</span></div>
    </div>
    <div class='section'>
        <h3>Informações Adicionais</h3>
        <div class='info-row'><span class='info-label'>Armazém:</span><span class='info-value'>" + registro.Armazem + @"</span></div>
        <div class='info-row'><span class='info-label'>Tipo Depósito:</span><span class='info-value'>" + registro.TipoDeposito + @"</span></div>
        <div class='info-row'><span class='info-label'>Pedido:</span><span class='info-value'>" + registro.Pedido + @"</span></div>
        <div class='info-row'><span class='info-label'>Localizador:</span><span class='info-value'>" + registro.Localizador + @"</span></div>
    </div>
    <div class='footer'><p>Documento gerado em " + dataHoraAtual + @" - Usuário: JD</p></div>
    <script>window.onload = function() { window.print(); }</script>
</body>
</html>";

        var htmlEscaped = html.Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "");
        await JSRuntime.InvokeVoidAsync("eval", "var w = window.open('', '_blank'); w.document.write('" + htmlEscaped + "'); w.document.close();");
    }
}