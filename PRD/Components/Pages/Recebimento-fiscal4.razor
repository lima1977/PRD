@page "/recebimento-fiscal4"
@using MudBlazor
@using PRD.Intefaces
@using PRD.Model
@inject IJSRuntime JSRuntime
@inject IBaseLNcsService BaseLNcsService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-2">
    <!-- Compact Header -->
    <MudPaper Elevation="0" Class="mb-3 pa-4" Style="background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 50%, #7c3aed 100%); border-radius: 16px;">
        <MudGrid>
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudAvatar Color="Color.Surface" Size="Size.Large" Class="mr-3">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h5" Color="Color.Surface" Class="font-weight-bold">Recebimento Fiscal</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Surface" Style="opacity: 0.9;">Usuário: JD</MudText>
                </div>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end">
                <MudChip T="string" Color="Color.Surface" Icon="@Icons.Material.Filled.Inventory" Size="Size.Large">
                    <b>@totalLancamentos</b> Lançamentos
                </MudChip>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid>
        <!-- Left Panel - Formulário -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 16px; height: 100%;">
                <!-- Tabs para organizar informações -->
                <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" Position="Position.Top" PanelClass="pa-4">
                    <!-- Tab 1: Dados do Transporte -->
                    <MudTabPanel Text="Transporte" Icon="@Icons.Material.Filled.LocalShipping">
                        <MudGrid Spacing="2">
                            <!-- Autocomplete para Número de Controle -->
                            <MudItem xs="12" sm="6">
                                <MudAutocomplete T="BaseLNcs"
                                                 Label="Número Controle (ID)"
                                                 @bind-Value="registroSelecionado"
                                                 SearchFunc="@BuscarPorNumeroControle"
                                                 ToStringFunc="@(e => e?.Id.ToString())"
                                                 Variant="Variant.Filled"
                                                 Dense="true"
                                                 Margin="Margin.Dense"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Filled.Tag"
                                                 ResetValueOnEmptyText="true"
                                                 CoerceText="true"
                                                 CoerceValue="true"
                                                 DebounceInterval="300"
                                                 OnBlur="@CarregarDadosRegistro">
                                    <ItemTemplate Context="item">
                                        <MudText Typo="Typo.body2">ID: @item.Id - @item.Fornecedor</MudText>
                                        <MudText Typo="Typo.caption">NF: @item.NotaFiscal • @item.DataChegada?.ToString("dd/MM/yyyy")</MudText>
                                    </ItemTemplate>
                                </MudAutocomplete>
                            </MudItem>

                            <!-- Outros campos aqui -->
                        </MudGrid>
                    </MudTabPanel>

                    <!-- Tab 2: Dados Fiscais -->
                    <MudTabPanel Text="Fiscal" Icon="@Icons.Material.Filled.Assignment">
                        <MudGrid Spacing="2">
                            <!-- Campos do Tab 2 -->
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>

                <!-- Action Buttons -->
                <MudDivider Class="my-3" />
                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="SalvarDados">Salvar</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit">Alterar</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Clear" OnClick="LimparFormulario">Limpar</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Right Panel - Status e Consulta Rápida -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="2">
                <!-- Quick Stats -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Small" /> Status Rápido
                    </MudText>
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-2 text-center" Style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px;">
                                <MudText Typo="Typo.h6" Color="Color.Surface">@finalizados</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Surface">Finalizados</MudText>
                            </MudPaper>
                        </MudItem>
                        <!-- Outros campos de status -->
                    </MudGrid>
                </MudPaper>

                <!-- Busca Rápida -->
                <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 16px;">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" /> Busca Rápida
                    </MudText>
                    <MudStack Spacing="2">
                        <MudDatePicker Label="Data" @bind-Date="dataConsulta" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        <MudTextField Label="Buscar..." @bind-Value="busca" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense"
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" OnClick="BuscarRegistros">
                            Buscar
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    <!-- Tabela de Lançamentos -->
    <MudPaper Elevation="2" Class="mt-3 pa-4" Style="border-radius: 16px;">
        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.TableChart" /> Lançamentos Fiscais
        </MudText>
        <MudTable Items="@registrosFiltrados" Hover="true" Dense="true" Striped="true" Elevation="0" Loading="@carregando" PageSize="10">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Data/Hora</MudTh>
                <MudTh>Fornecedor</MudTh>
                <MudTh>Transportadora</MudTh>
                <MudTh>NF</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: center;">Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.Id</MudTd>
                <MudTd DataLabel="Data/Hora">
                    <MudText Typo="Typo.body2">@context.DataChegada?.ToString("dd/MM/yyyy")</MudText>
                    <MudText Typo="Typo.caption">@context.HoraChegada?.ToString(@"hh\:mm")</MudText>
                </MudTd>
                <MudTd DataLabel="Fornecedor">@context.Fornecedor</MudTd>
                <MudTd DataLabel="Transportadora">@context.Transportadora</MudTd>
                <MudTd DataLabel="NF">@context.NotaFiscal</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small" Variant="Variant.Filled">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Ações" Style="text-align: center;">
                    <MudTooltip Text="Editar">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditarRegistro(context))" />
                    </MudTooltip>
                    <MudTooltip Text="Imprimir">
                        <MudIconButton Icon="@Icons.Material.Filled.Print" Color="Color.Info" Size="Size.Small" OnClick="@(() => ImprimirRegistro(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    // Lista completa de registros
    private List<BaseLNcs> todosRegistros = new();
    private List<BaseLNcs> registrosFiltrados = new();
    private BaseLNcs? registroSelecionado;
    private bool carregando = false;

    // Campos do formulário
    private DateTime? dataChegada;
    private TimeSpan? horaChegada;
    private string transportadora = "";
    private string codigoTransportadora = "";
    private string nomeTransportadora = "";
    private string cnpjTransportadora = "";
    private string placaVeiculo = "";
    private string doca = "";
    private string fornecedor = "";
    private string razaoSocial = "";
    private string notaFiscal = "";
    private string serie = "";
    private decimal? qtdAgendada;
    private decimal? qtdRecebida;
    private string tipoDeposito = "";
    private string categoriaPlano = "";
    private string armazem = "";
    private string senha = "";
    private string statusFiscal = "Aguardando";
    private string statusSenha = "";
    private DateTime? dataLancamento;
    private TimeSpan? horaLancamento;
    private DateTime? dataEnvioBOSS;
    private TimeSpan? horaEnvioBOSS;
    private DateTime? dataChamada;
    private TimeSpan? horaChamada;
    private DateTime? dataAprovacao;
    private TimeSpan? horaAprovacao;
    private string pedido = "";
    private string localizador = "";

    // Consulta
    private DateTime? dataConsulta = DateTime.Now;
    private string busca = "";

    // Estatísticas
    private int totalLancamentos = 0;
    private int finalizados = 0;
    private int emConferencia = 0;
    private int aguardando = 0;
    private int pendentes = 0;

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        try
        {
            carregando = true;
            todosRegistros = await BaseLNcsService.ObterTodosAsync(0, 10); // Paginado
            registrosFiltrados = todosRegistros;
            totalLancamentos = todosRegistros.Count;
            AtualizarEstatisticas();
            carregando = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados: {ex.Message}", Severity.Error);
            carregando = false;
        }
    }

    private void AtualizarEstatisticas()
    {
        finalizados = todosRegistros.Count(x => x.Status == "Finalizado");
        emConferencia = todosRegistros.Count(x => x.Status == "Em Conferência");
        aguardando = todosRegistros.Count(x => x.Status == "Aguardando");
        pendentes = todosRegistros.Count(x => x.Status == "Pendente");
    }

    private async Task<IEnumerable<BaseLNcs>> BuscarPorNumeroControle(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Enumerable.Empty<BaseLNcs>();

        return await BaseLNcsService.ObterTodosAsync(0, 10); // Pesquisa otimizada
    }

    private void CarregarDadosRegistro()
    {
        if (registroSelecionado == null) return;

        // Carregar dados do registro selecionado
    }

    private void BuscarRegistros()
    {
        if (string.IsNullOrWhiteSpace(busca))
        {
            registrosFiltrados = todosRegistros;
        }
        else
        {
            registrosFiltrados = todosRegistros
                .Where(x => x.Id.ToString().Contains(busca) ||
                           (x.Fornecedor?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (x.NotaFiscal?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (x.Transportadora?.Contains(busca, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }
        Snackbar.Add($"Encontrados {registrosFiltrados.Count} registros", Severity.Info);
    }

    private Color GetStatusColor(string? status)
    {
        return status switch
        {
            "Finalizado" => Color.Success,
            "Em Conferência" => Color.Info,
            "Aguardando" => Color.Warning,
            "Pendente" => Color.Error,
            _ => Color.Default
        };
    }

    private async Task SalvarDados()
    {
        if (registroSelecionado == null)
        {
            Snackbar.Add("Selecione um registro para salvar!", Severity.Warning);
            return;
        }

        try
        {
            // Atualizar o registro selecionado
            var sucesso = await BaseLNcsService.AtualizarAsync(registroSelecionado);

            if (sucesso)
            {
                Snackbar.Add("Dados salvos com sucesso!", Severity.Success);
                await CarregarDados();
                AtualizarEstatisticas();
            }
            else
            {
                Snackbar.Add("Erro ao salvar dados!", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar: {ex.Message}", Severity.Error);
        }
    }

    private void LimparFormulario()
    {
        registroSelecionado = null;
        // Limpar outros campos
        Snackbar.Add("Formulário limpo!", Severity.Info);
    }

    private void EditarRegistro(BaseLNcs registro)
    {
        registroSelecionado = registro;
        CarregarDadosRegistro();
    }

    private async Task ImprimirRegistro(BaseLNcs registro)
    {
        var dataHoraAtual = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
        var statusClass = registro.Status?.ToLower().Replace(" ", "-") ?? "aguardando";

        var html = @"<html>...</html>"; // Código HTML gerado para impressão

        var htmlEscaped = html.Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "");
        await JSRuntime.InvokeVoidAsync("eval", "var w = window.open('', '_blank'); w.document.write('" + htmlEscaped + "'); w.document.close();");
    }
}
